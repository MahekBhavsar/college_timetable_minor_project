<div class="container-fluid p-4 bg-light min-vh-100">
  @if (isLoading()) {
    <div class="text-center py-5 mt-5">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2 fw-bold text-primary">Syncing Database...</p>
    </div>
  } @else {
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body d-flex flex-wrap gap-3 align-items-center bg-white rounded shadow-sm p-3">
        <h4 class="fw-bold mb-0 text-primary me-2">BCA Department Scheduler</h4>
        
        <div class="btn-group btn-group-sm me-3">
          <button class="btn" [class.btn-primary]="viewMode() === 'class'" (click)="viewMode.set('class')">Division</button>
          <button class="btn" [class.btn-primary]="viewMode() === 'staff'" (click)="viewMode.set('staff')">Faculty</button>
        </div>

        <button class="btn btn-success btn-sm px-3 shadow-sm ms-2" (click)="generateFullTimetable()" [disabled]="isGenerating()">‚ö° Generate Cycle</button>

        <div class="ms-auto d-flex gap-2 align-items-center">
          @if (viewMode() === 'class') {
            <select [ngModel]="selectedSem()" (ngModelChange)="selectedSem.set(+$event)" class="form-select form-select-sm w-auto border-primary fw-bold">
              <optgroup label="Odd Cycle">
                @for (s of [1,3,5]; track s) { <option [value]="s">Sem {{s}}</option> }
              </optgroup>
              <optgroup label="Even Cycle (Replacement Mode)">
                @for (s of [2,4,6]; track s) { <option [value]="s">Sem {{s}}</option> }
              </optgroup>
            </select>
            <select [ngModel]="selectedDiv()" (ngModelChange)="selectedDiv.set($event)" class="form-select form-select-sm w-auto border-primary fw-bold">
              @for (d of ['A', 'B', 'C']; track d) { <option [value]="d">Div {{d}}</option> }
            </select>
          } @else {
            <select [ngModel]="selectedStaffId()" (ngModelChange)="selectedStaffId.set($event)" class="form-select form-select-sm w-auto border-info">
              <option value="">-- Choose Professor --</option>
              @for (st of staffList(); track st.id) { <option [value]="st.id">{{st.name}}</option> }
            </select>
          }
        </div>
      </div>
    </div>

    <div class="card border-0 shadow-sm overflow-hidden rounded-4">
      <table class="table table-bordered mb-0 text-center align-middle bg-white">
        <thead class="table-dark small">
          <tr><th style="width: 180px;">TIME</th> @for (d of days; track d) { <th>{{d}}</th> } </tr>
        </thead>
        <tbody>
          @for (slot of currentTimeSlots; track slot.label) {
            @if (slot.isRecess) {
              <tr class="recess-row">
                <td class="small fw-bold text-danger">{{ slot.label }}</td>
                <td [attr.colspan]="days.length" class="py-2 small text-center">üç± COMPULSORY BREAK üç±</td>
              </tr>
            } @else {
              <tr>
                <td class="bg-light small fw-bold text-secondary">{{ slot.label }}</td>
                @for (dayName of days; track dayName) {
                  <td class="slot-cell p-1">
                    @for (s of (timetable$ | async); track s.id) {
                      @if (viewMode() === 'class' && s.day === dayName && s.time === slot.label && s.sem === selectedSem() && s.div === selectedDiv()) {
                        <div class="card p-2 text-start shadow-sm border-start border-4 mb-1" [class.type-lab]="s.type === 'Lab'" [class.type-lecture]="s.type === 'Lecture'">
                          <div class="fw-bold extra-small text-dark">{{ s.subject }}</div>
                          <div class="text-primary extra-small">üë®‚Äçüè´ {{ s.staffName }}</div>
                          <div class="extra-small badge bg-light text-dark border mt-1 w-fit">{{ s.roomName }}</div>
                        </div>
                      }
                      @if (viewMode() === 'staff' && s.day === dayName && s.time === slot.label && s.staffId === selectedStaffId() && s.staffId !== '') {
                        <div class="card p-2 text-start shadow-sm mb-1 border-start border-4" [class.type-lab]="s.type === 'Lab'" [class.type-lecture]="s.type === 'Lecture'">
                          <div class="fw-bold extra-small text-dark">{{ s.subject }}</div>
                          <div class="text-success extra-small fw-bold">üè´ Sem {{ s.sem }} - Div {{ s.div }}</div>
                          <div class="extra-small badge bg-light text-dark border mt-1 w-fit">{{ s.roomName }}</div>
                        </div>
                      }
                    }
                  </td>
                }
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  }
</div>